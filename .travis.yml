sudo: required

language: minimal

services:
  - docker

env:
  global:
    - IMAGE_NAME=donkeybot
    - REGISTRY=suchtilt.azurecr.io

install: true
before_script:
  - docker login -u "$REGISTRY_USERNAME" -p "$REGISTRY_PASSWORD" "$REGISTRY"
  - docker pull "$REGISTRY/$IMAGE_NAME" || true
script:
  - docker build --pull --cache-from "$REGISTRY/$IMAGE_NAME" --tag "$REGISTRY/$IMAGE_NAME" .
after_script:
  - docker images

deploy:
  provider: script
  script: docker push "$REGISTRY/$IMAGE_NAME"
  on:
    branch: master